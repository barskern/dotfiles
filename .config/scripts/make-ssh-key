#!/usr/bin/env bash

set -e

exec 3>&1
exec 1>&2

SSH_DIR="$HOME/.ssh"
SSH_CONFIG="$SSH_DIR/config"
DEFAULT_KEY_TYPE="ed25519"

function error() {
	echo -e "\u001b[31mError: $*\u001b[0m"
}

echo -n "Username of local user ($(whoami)): "; read -r local_username
local_username="${local_username:-"$(whoami)"}"

echo -n "FQDN or domain, e.g. 'github.com': "; read -r domain
if [ -z "$domain" ]; then
	error "A domain is required"
	exit 1
fi

echo -n "Type of key ($DEFAULT_KEY_TYPE): "; read -r key_type
key_type="${key_type:-"$DEFAULT_KEY_TYPE"}"

comment="$local_username@$(hostname)"
sanitized_domain=$(\
	echo "$domain" \
		| sed 's/^[\*\.]*//;s/\.*$//' \
		| tr '.' '_' \
)
filename="$SSH_DIR/id_$sanitized_domain"

echo "Creating ssh key..."
ssh-keygen -q \
	-t "$key_type" \
	-a 100 \
	-f "$filename" \
	-N "" \
	-C "$comment"

echo "Created ssh key at $filename"

echo -n "Upload key to '$domain' with 'ssh-copy-id' (y/[n])?"; read -r remote_copy
if [ "$remote_copy" = "y" ]; then
	echo "Uploading to remote with 'ssh-copy-id'..."
	ssh-copy-id -i "$filename" "$domain"
fi

echo "Removing old entry in $SSH_CONFIG"
sed -i "/# autogenerated $domain/,/# autogenerated end/d" "$SSH_CONFIG"

echo "Adding entry to $SSH_CONFIG"
cat <<EOF >> "$SSH_CONFIG"
# autogenerated $domain
Host $domain
	IdentityFile $filename
# autogenerated end
EOF

echo "Outputting public key to stdout"
cat "$filename.pub" >&3
